name: Windows Builds

on:
  push:
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - 'Assets/**'
      - 'Docs/**'

  pull_request:
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - 'Assets/**'
      - 'Docs/**'

  workflow_dispatch:

env:
  PLATFORM_NAME: Win32
  BUILD_TYPE: RelWithDebInfo
  UPLOAD_ARTIFACT: true
  CACHE_DEPS: false
  FIXED_CMAKE_VERSION: 3.21.4

jobs:
  Build:
    # 使用 windows-2022 runner（带有 Visual Studio 2022）
    runs-on: windows-2022

    defaults:
      run:
        shell: cmd

    steps:
      - name: Checkout repository
        # 将 checkout 升级为 v4（较新、受支持）
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare build directory
        run: mkdir Build

      - name: Generate dependencies cache key
        if: env.CACHE_DEPS == 'true'
        run: |
          curl -o Build/DepsRef.json https://api.github.com/repos/SpriteOvO/AirPodsDesktop-Deps/git/refs/heads/main
          type DepsRef.json

      - name: Dependencies cache
        id: cache-deps
        if: env.CACHE_DEPS == 'true'
        # 升级 actions/cache 到 v4
        uses: actions/cache@v4
        with:
          path: Build/AirPodsDesktop-Deps
          key: ${{ hashFiles('Build/DepsRef.json') }}

      - name: Clone dependencies
        if: env.CACHE_DEPS != 'true' || steps.cache-deps.outputs.cache-hit != 'true'
        working-directory: Build
        run: |
          git clone --recursive https://github.com/SpriteOvO/AirPodsDesktop-Deps.git
          dir AirPodsDesktop-Deps

      - name: Print CMake version
        run: cmake --version

      - name: Use a fixed version of CMake
        if: env.FIXED_CMAKE_VERSION != ''
        run: |
          choco install cmake.install --version ${{ env.FIXED_CMAKE_VERSION }} --installargs 'ADD_CMAKE_TO_PATH=System' --force
          cmake --version

      - name: Clone and bootstrap vcpkg
        working-directory: Build
        run: |
          git clone --recursive https://github.com/microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg.bat -disableMetrics

      - name: Install Qt 5.15.2 (msvc2022 32-bit) 
        # 使用 lukka/get-qt@v3 作为示例安装器；你可替换为其它 setup-qt action
        uses: lukka/get-qt@v3
        with:
          version: '5.15.2'
          host: 'windows'
          arch: 'msvc2022_32'

      - name: Find Qt5Config.cmake and export Qt5_DIR and add Qt bin to PATH
        shell: powershell
        run: |
          Write-Host "Searching for Qt5Config.cmake..."
          # 常见安装位置（包括 where lukka/get-qt 可能放置的位置）
          $candidates = @(
            'C:\Qt',
            'C:\hostedtoolcache\windows',
            'C:\msys64',
            'C:\Program Files\Qt'
          )
          $found = $null
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              $f = Get-ChildItem -Path $p -Filter 'Qt5Config.cmake' -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($f) { $found = $f; break }
            }
          }
          if (-not $found) {
            # 作为最后手段进行全盘搜索（在 CI 上这通常可以工作，但会慢一些）
            $found = Get-ChildItem -Path C:\ -Filter 'Qt5Config.cmake' -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          }
          if ($found) {
            $qt5_dir = $found.Directory.FullName
            Write-Host "Found Qt5Config.cmake at $($found.FullName)"
            Write-Host "Setting Qt5_DIR = $qt5_dir"
            "# 为 CMake 提供 Qt5Config 路径" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "Qt5_DIR=$qt5_dir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

            # 计算 Qt 根目录并加入 PATH，便于 windeployqt 等可执行文件可被调用
            # Qt5Config.cmake 通常位于 <QtRoot>\lib\cmake\Qt5
            $dirObj = Get-Item $found.Directory.FullName
            $qtroot = $dirObj.Parent.Parent.Parent.FullName
            $qtbin = Join-Path $qtroot 'bin'
            Write-Host "Inferred Qt root: $qtroot"
            Write-Host "Adding Qt bin to PATH: $qtbin"
            "PATH=$qtbin;$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            Write-Error "Qt5Config.cmake not found. Ensure the Install Qt step succeeded and that the chosen action places Qt on disk."
            exit 1
          }

      - name: Generate project and build
        working-directory: Build
        run: |
          mkdir ${{ env.BUILD_TYPE }} && cd ${{ env.BUILD_TYPE }}

          cmake -G "Visual Studio 17 2022" ^
                -A ${{ env.PLATFORM_NAME }} ^
                -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ^
                -DCMAKE_TOOLCHAIN_FILE=../vcpkg/scripts/buildsystems/vcpkg.cmake ^
                -DQt5_DIR=%Qt5_DIR% ^
                -DAPD_GENERATE_INSTALLER=ON ^
                -DAPD_BUILD_GIT_HASH=${{ github.sha }} ^
                ../../

          cmake --build . ^
                --config ${{ env.BUILD_TYPE }}

          dir /s Binary
          dir /s Installer

      - name: Prepare artifacts
        if: env.UPLOAD_ARTIFACT == 'true'
        working-directory: Build\${{ env.BUILD_TYPE }}\Installer
        run: |
          cd _CPack_Packages\win32\NSIS
          move AirPodsDesktop-*-win32 AirPodsDesktop-${{ github.sha }}-win32

      - name: Upload artifact - Installer
        # 升级 upload-artifact 到 v4
        uses: actions/upload-artifact@v4
        if: env.UPLOAD_ARTIFACT == 'true'
        with:
          name: AirPodsDesktop-${{ github.sha }}-Installer
          path: Build\${{ env.BUILD_TYPE }}\Installer\AirPodsDesktop-*-win32.exe
          retention-days: 90

      - name: Upload artifact - Portable
        uses: actions/upload-artifact@v4
        if: env.UPLOAD_ARTIFACT == 'true'
        with:
          name: AirPodsDesktop-${{ github.sha }}-Portable
          path: Build\${{ env.BUILD_TYPE }}\Installer\_CPack_Packages\win32\NSIS\AirPodsDesktop-${{ github.sha }}-win32\AirPodsDesktop
          retention-days: 90
